<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="tabs/pedidos"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ isEdit() ? 'Editar Pedido' : 'Novo Pedido' }}</ion-title>
      <ion-buttons *ngIf="isEdit()" slot="end">
        <ion-button>
            <span (click)="confirmDelete()" class="material-symbols-outlined remove-btn " style="padding-right: 6px;">
            delete
            </span>
        </ion-button>
    </ion-buttons>       
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding-horizontal ion-padding-bottom">
  <form (ngSubmit)="save()" [formGroup]="form">
    <div class="section-container">
      <h3 class="section-title">Informações</h3>
      
      <ion-item class="custom-item" lines="none">
        <ion-input 
          label="Cliente" 
          labelPlacement="stacked" 
          formControlName="customerName" 
          required
          class="custom-input">
        </ion-input>
      </ion-item>
          <!-- TODO: Alterar a exibição da data -->
      <ion-item class="custom-item" lines="none">
        <ion-input  
          label="Data de Entrega" 
          labelPlacement="stacked" 
          type="date"
          [value]="(form.get('deadlineDate')?.value | date:'yyyy-MM-dd')"
          (ionChange)="form.patchValue({ deadlineDate: $event.detail.value })"
          class="custom-input">
        </ion-input>
      </ion-item>
    </div>

    <!-- Seção de itens -->
    <div class="section-container">
      <div class="section-header">
        <h3 class="section-title">
          Itens
        </h3>
         <ion-button class="icon-button" fill="clear">
            <span (click)="addItem()" class="material-symbols-outlined add-item-btn">add</span>
        </ion-button>
        
      </div>
      <div class="items-container">
        <div 
          *ngFor="let g of itemsFA.controls; let i = index" 
          class="item-card"
          [formGroup]="g">
          
          <div class="item-header">
            <span class="item-number">Item {{ i + 1 }}</span>
            <ion-button 
              *ngIf="itemsFA.length > 1"
              fill="clear" 
              color="danger"
              size="small"
              (click)="removeItem(i)"
              class="icon-button">
                <span (click)="removeItem(i)" class="material-symbols-outlined remove-btn"> delete </span>
            </ion-button>
          </div>

          <ion-item class="custom-item" lines="none">
            <ion-label position="stacked">Produto</ion-label>
            <ion-select 
              interface="action-sheet" 
              formControlName="productId" 
              (ionChange)="onProductChange(i)"
              placeholder="Selecione um produto"
              class="custom-select">
              <ion-select-option *ngFor="let p of products()" [value]="p.id">
                {{ p.name }} ({{ p.quantity }} em estoque)
              </ion-select-option>
            </ion-select>
          </ion-item>

          <div class="input-row">
            <ion-item class="custom-item flex-item" lines="none">
              <ion-input 
                type="number" 
                label="Quantidade" 
                labelPlacement="stacked" 
                formControlName="quantity"
                min="1"
                class="custom-input">
              </ion-input>
            </ion-item>

            <ion-item class="custom-item flex-item" lines="none">
              <ion-input 
                type="number" 
                label="Preço unitário" 
                labelPlacement="stacked" 
                formControlName="unitPrice"
                min="0"
                step="0.01"
                class="custom-input">
              </ion-input>
            </ion-item>
          </div>
        </div>
      </div>
    </div>
  </form>
    <ion-fab slot="fixed" vertical="bottom" horizontal="start">
       <div class="total-container">
        <h2 class="total-text">R$ {{ total() | number:'1.2-2' }}</h2>
      </div>
    </ion-fab>
    <ion-fab slot="fixed" vertical="bottom" horizontal="end">
      <ion-fab-button
        type="submit" 
        [disabled]="form.invalid || itemsFA.length === 0"
        (click)="save()" 
        class="fab-button"
        >
        <span class="material-symbols-outlined">save</span>
      </ion-fab-button>
    </ion-fab>
</ion-content>


